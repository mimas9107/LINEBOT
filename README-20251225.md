## 專案概述
+ **名稱**：LINEBOT（整合 Google Gemini）
+ **說明**：以 Flask 建置的 LINE 機器人範例，支援把特定文字轉發給 Google Gemini、處理圖片上傳並回傳 AI 分析結果，並可將訊息紀錄到 Google Sheets（透過 Google Apps Script）。

## 專案目錄與檔案結構（以本次分析為準）
- 根目錄重要檔案：
	- `app.py` — 主程式，包含 Flask webhook、LINE 事件處理、Gemini 串接與訊息記錄功能。
	- `README-20251225.md` —（本檔）繁體中文說明。
	- `README.md` — 原始英文/中文混合說明（歷史紀錄）。
	- `requirements.txt` — 相依套件清單。
	- `.gitignore`

- Gemini 範例與圖片處理：
	- `gemini.py` — Gemini 文本聊天範例（示範呼叫模型並印出回應）。
	- `gemini_pic.py` — Gemini 的影像分析範例（將本機圖片送到模型）。
	- `gemini_pic.py` 與 `gemini.py` 皆示範 `google.generativeai` / `google.genai` 的基本使用方式。

- Rich Menu 與圖文選單：
	- `richmenu.py` — 使用 LINE Messaging API 建立並上傳 Rich Menu 的範例程式。
	- `pic_select.py` — 利用 HTTP API 建立圖文選單的 JSON 範例。
	- `settingbg.py` — 上傳 Rich Menu 圖片並將 rich menu 指派給所有使用者的範例。

- 靜態資源與圖片：
	- `pic/` 目錄 — 包含 rich menu 圖片與範例圖片，例如 `line-rich-menu-demo.jpg`, `richmenu-a.png`, `richmenu-b.png`, `downloadimg.jpg`, `raspberry-pi-3-pinout-768x810.jpg`。

- Google Apps Script（另有部署在 Google 的腳本）：
	- `google_app_script/` 目錄，包含：
		- `main.gs`
		- `linebot.gs`
		- `AI.gs`
		- `BookMark.gs`
		- `UrlHandler.gs`
	這些 `.gs` 檔負責接收來自 `app.py` 的 POST 請求、讀寫 Google Sheet（歷史紀錄、書籤等）。

## 相依性
- 建議 Python 版本：3.10+
- 主要套件請參考 `requirements.txt`：
	- Flask
	- line-bot-sdk
	- google-generativeai
	- google-genai
	- pillow
	- gunicorn

## 環境變數（.env / 系統環境）
- `LINE_CHANNEL_ACCESS_TOKEN`：LINE channel access token
- `LINE_CHANNEL_SECRET`：LINE channel secret（Webhook 驗證用）
- `GEMINI_API_KEY`：Google Gemini / Generative AI API key
- `GOOGLE_APPS_SCRIPT_URL`：已部署的 Google Apps Script URL（用於記錄訊息、取得歷史）

範例 `.env`（請勿推上 Git）：
```
LINE_CHANNEL_ACCESS_TOKEN=你的_LINE_TOKEN
LINE_CHANNEL_SECRET=你的_LINE_SECRET
GEMINI_API_KEY=你的_GEMINI_KEY
GOOGLE_APPS_SCRIPT_URL=https://script.google.com/macros/s/XXXX/exec
```

## 運作流程（高層）
- `app.py` 提供 `/callback` 路由接收 LINE Webhook，使用 `linebot.v3` 解析事件。
- 當收到文字訊息且以 `ai:` 開頭時，會（選擇性地）從 Google Apps Script 取得歷史對話，並將組裝後的 prompt 傳給 Gemini（`GeminiChatBot()`）。
- 當收到圖片訊息時，先從 LINE 下載圖片到 `pic/downloadimg.jpg`，再根據設定選擇傳到本機 LMStudio（`send_image_to_AI`）或呼叫 Gemini 的影像模型（`GeminiChatBot_pic()`）。
- 訊息會視設定將使用者訊息傳送到 `GOOGLE_APPS_SCRIPT_URL`，以便寫入 Google Sheet（做歷史或書籤功能）。
- 背景執行緒會定期執行 keepalive/監控工作（`pingself`、`pingout`、`googlesheetlog`）。

## 本機執行（開發）
1. 安裝相依套件：
```bash
pip install -r requirements.txt
```
2. 建立 `.env`（或在系統環境設定變數）並填入必要值。
3. 啟動開發伺服器：
```bash
python app.py
```
4. 部署建議：使用 `gunicorn app:app` 或部署到 Render/Heroku 類平台。

## 注意事項與建議
- Google Gemini SDK / 模型名稱會變動：程式中使用的 `gemini-2.0-flash-exp`、`gemini-2.5-flash` 等型號可能因 API 權限或 SDK 版本不同而無法使用，部署前請確認可用模型與 SDK 版本。
- 使用影像功能時請確認 API 金鑰是否有 vision 權限，或使用本地 LMStudio 時確認本地服務可達。
- 請務必勿將 `.env` 或任何金鑰推上版本控制系統。
- 若要進一步穩定：把設定集中管理（如使用 `python-dotenv` 並統一讀取）、增加錯誤處理、加入測試範例與 CI。

---
說明產生日期：2025-12-25
